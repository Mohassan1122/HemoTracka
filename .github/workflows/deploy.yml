name: Deploy to VPS

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SYDANI_WEB_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: ssh-keyscan -H 85.9.202.212 >> ~/.ssh/known_hosts

      - name: Set deployment path
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "DEPLOY_PATH=/var/www/hemotrackr/prod/api" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "DEPLOY_PATH=/var/www/hemotrackr/dev/api" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=/var/www/hemotrackr/staging/api" >> $GITHUB_ENV
          fi

      - name: Debug deployment path
        run: |
          echo "Deploying to: $DEPLOY_PATH"

      - name: Create deployment directory on server
        run: ssh -o StrictHostKeyChecking=no root@85.9.202.212 "mkdir -p $DEPLOY_PATH"

      - name: Copy source code to server
        run: |
          rsync -avz --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            --exclude '.next/' \
            --exclude 'static/' \
            --exclude 'media/' \
            --exclude 'storage/' \
            --exclude 'public/' \
            --exclude '.dockerignore' \
            --exclude 'docker-compose.yml' \
            --exclude 'Dockerfile' \
            --exclude 'deploy.sh' \
            --exclude 'docker-entrypoint.sh' \
            --exclude 'entrypoint.sh' \
            --exclude '.env' \
            ./ root@85.9.202.212:$DEPLOY_PATH/

      - name: Build and deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no root@85.9.202.212 "cd $DEPLOY_PATH && bash ./deploy.sh"
